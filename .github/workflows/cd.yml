name: CD Pipeline

on:
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write


    steps:
    # ----------------------------------------------------
    # 1. Checkout repository
    # ----------------------------------------------------
    - name: Checkout code
      uses: actions/checkout@v4

    # ----------------------------------------------------
    # 2. Configure AWS credentials
    # ----------------------------------------------------
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-west-2

    # ----------------------------------------------------
    # 3. Setup kubectl
    # ----------------------------------------------------
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: v1.30.0

    # ----------------------------------------------------
    # 4. Update kubeconfig for EKS
    # ----------------------------------------------------
    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig \
          --region us-west-2 \
          --name secure-node-cluster

    - name: Update image tag
      run: |
        kubectl set image deployment/secure-node-api \
          app=shadoww717/secure-node-api:${{ github.sha }}

    # ----------------------------------------------------
    # 5. Deploy application to EKS
    # ----------------------------------------------------
    - name: Deploy new image
      run: |
        kubectl set image deployment/secure-node-api \
          app=shadoww717/secure-node-api:${{ github.sha }}

    - name: Wait for rollout
      run: |
        kubectl rollout status deployment/secure-node-api


    # ----------------------------------------------------
    # 7. Get Service External IP
    # ----------------------------------------------------
    - name: Get service external IP
      run: |
        kubectl get svc secure-node-api-service


    # ----------------------------------------------------
    # 8. DAST â€“ OWASP ZAP (Baseline)
    # ----------------------------------------------------
    - name: Run OWASP ZAP DAST Scan
      uses: zaproxy/action-baseline@v0.14.0
      with:
        target: http://aa2980a90178a48f68aa180d865c3f0f-412108368.us-west-2.elb.amazonaws.com/
        fail_action: false
        allow_issue_writing: false
        artifact_name: zap_scan

