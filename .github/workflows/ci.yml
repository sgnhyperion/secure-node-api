name: CI Pipeline

on:
  push:
  workflow_dispatch:

jobs:
  ci:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write 

    steps:
    # ----------------------------------------------------
    # 1. Checkout
    # ----------------------------------------------------
    - uses: actions/checkout@v4

    # ----------------------------------------------------
    # 2. Setup Node.js
    # ----------------------------------------------------
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: npm

    # ----------------------------------------------------
    # 3. Install dependencies
    # ----------------------------------------------------
    - name: Install dependencies
      run: npm ci

    # ----------------------------------------------------
    # 4. Linting
    # ----------------------------------------------------
    - name: ESLint
      run: npm run lint
      continue-on-error: true

    # ----------------------------------------------------
    # 5. SAST – CodeQL
    # ----------------------------------------------------
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: javascript

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

    # ----------------------------------------------------
    # 6. SCA – Dependency Scan
    # ----------------------------------------------------
    - name: npm audit
      run: npm audit --audit-level=high
      continue-on-error: true

    # ----------------------------------------------------
    # 7. Unit Tests
    # ----------------------------------------------------
    - name: Run Tests
      run: npm test

     # 8. Login to DockerHub
    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # ----------------------------------------------------
    # 9. Docker Build
    # ----------------------------------------------------
    - name: Build and Push Docker image
      run: |
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/secure-node-api:latest .
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/secure-node-api:latest

    # ----------------------------------------------------
    # 10. Trivy Image Scan
    # ----------------------------------------------------
    - name: Trivy Scan
      uses: aquasecurity/trivy-action@0.24.0
      with:
        image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/secure-node-api:latest
        severity: CRITICAL,HIGH
        exit-code: 0

    # ----------------------------------------------------
    # 11. Container Smoke Test
    # ----------------------------------------------------
    - name: Run container and test
      run: |
        docker run -d -p 3000:3000 --name app secure-node-api
        sleep 5
        curl -f http://localhost:3000/health
        docker rm -f app
